<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SilentWhispers | Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-white text-purple-700">

<!-- Navbar -->
<header class="w-full bg-white shadow-sm">
  <nav class="max-w-7xl mx-auto flex items-center justify-between px-6 py-4">
    <h1 class="text-2xl font-bold text-purple-700">
      <a href="index.html">SilentWhispers</a>
    </h1>

    <div class="flex items-center gap-6 text-purple-600 font-medium">
      <a href="translator.html">Translator</a>
      <a href="about.html">About</a>
      <button id="logoutBtn"
        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
        Logout
      </button>
    </div>
  </nav>
</header>

<!-- Main -->
<main class="flex justify-center items-center min-h-[calc(100vh-80px)]
             bg-gradient-to-br from-blue-50 via-purple-100 to-pink-100 px-4">

  <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl p-8">
    <h2 class="text-3xl font-bold text-center text-purple-700 mb-8">
      User Profile
    </h2>

    <!-- Avatar -->
    <div class="flex flex-col items-center mb-8 gap-3">
      <img id="avatar"
        src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
        class="w-28 h-28 rounded-full border-4 border-purple-600 object-cover" />

      <input type="file" id="imageInput" accept="image/*"
        class="text-sm text-gray-600
               file:mr-4 file:py-2 file:px-4
               file:rounded-lg file:border-0
               file:bg-purple-100 file:text-purple-700
               hover:file:bg-purple-200">
    </div>

    <form class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <div>
        <label class="font-medium">Username</label>
        <input id="name" type="text"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
      </div>

      <div>
        <label class="font-medium">Email</label>
        <input id="email" type="email"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
      </div>

      <div>
        <label class="font-medium">New Password</label>
        <input id="newPassword" type="password"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
      </div>

      <div>
        <label class="font-medium">Confirm Password</label>
        <input id="confirmPassword" type="password"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" />
      </div>

    </form>

    <div class="flex justify-center gap-6 mt-10">
      <button id="saveBtn"
        class="bg-purple-700 text-white px-6 py-2 rounded-lg hover:bg-purple-800">
        Save Changes
      </button>
      <a href="index.html"
        class="bg-gray-300 px-6 py-2 rounded-lg hover:bg-gray-400">
        Go Back
      </a>
    </div>

    <p id="message" class="text-center mt-4"></p>
  </div>

</main>

<!-- Firebase Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    updateProfile,
    updateEmail,
    updatePassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBiB3oGz0iRkPnYBQPpAL_VuSc7iKMi47U",
    authDomain: "user-login-system-758dc.firebaseapp.com",
    projectId: "user-login-system-758dc",
    storageBucket: "user-login-system-758dc.appspot.com",
    messagingSenderId: "918704461614",
    appId: "1:918704461614:web:9dc1bfa1b7edc2da394cbf"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const avatar = document.getElementById("avatar");
  const imageInput = document.getElementById("imageInput");
  const nameInput = document.getElementById("name");
  const emailInput = document.getElementById("email");
  const newPass = document.getElementById("newPassword");
  const confirmPass = document.getElementById("confirmPassword");
  const message = document.getElementById("message");

  let currentUser;
  let selectedImage;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUser = user;
    nameInput.value = user.displayName || "";
    emailInput.value = user.email;
    if (user.photoURL) avatar.src = user.photoURL;

    const refDoc = doc(db, "users", user.uid);
    if (!(await getDoc(refDoc)).exists()) {
      await setDoc(refDoc, {
        name: user.displayName || "",
        email: user.email,
        photoURL: user.photoURL || ""
      });
    }
  });

  imageInput.onchange = (e) => {
    selectedImage = e.target.files[0];
    avatar.src = URL.createObjectURL(selectedImage);
  };

  document.getElementById("saveBtn").onclick = async () => {
    if (newPass.value && newPass.value !== confirmPass.value) {
      message.textContent = "Passwords do not match";
      message.className = "text-red-500";
      return;
    }

    try {
      let photoURL = currentUser.photoURL;

      if (selectedImage) {
        const imgRef = ref(storage, `profiles/${currentUser.uid}/avatar.jpg`);
        await uploadBytes(imgRef, selectedImage);
        photoURL = await getDownloadURL(imgRef);
      }

      await updateProfile(currentUser, {
        displayName: nameInput.value,
        photoURL
      });

      if (emailInput.value !== currentUser.email) {
        await updateEmail(currentUser, emailInput.value);
      }

      if (newPass.value) {
        await updatePassword(currentUser, newPass.value);
      }

      await updateDoc(doc(db, "users", currentUser.uid), {
        name: nameInput.value,
        email: emailInput.value,
        photoURL
      });

      message.textContent = "Profile updated successfully!";
      message.className = "text-green-600";
      alert(message.textContent);

    } catch (err) {
      message.textContent = err.message;
      message.className = "text-red-500";
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    window.location.href = "login.html";
  };
</script>

</body>
</html>
